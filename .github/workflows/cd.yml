name: CD Pipeline - Deploy to Azure VM

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if CI fails'
        required: false
        default: 'false'
        type: boolean

env:
  COMPOSE_PROJECT_NAME: logarithm-warehouse

jobs:
  # First run CI checks on GitHub-hosted runner
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (validation)
        run: docker compose build

  # Deploy to Azure VM using self-hosted runner
  deploy:
    needs: ci-check
    runs-on: [self-hosted, azure, warehouse]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare deployment directory
        run: |
          sudo mkdir -p /opt/logarithm-warehouse
          sudo chown -R $USER:$USER /opt/logarithm-warehouse
          rsync -av --delete --exclude='.git' --exclude='node_modules' ./ /opt/logarithm-warehouse/

      - name: Stop existing containers
        working-directory: /opt/logarithm-warehouse
        run: |
          docker compose down --remove-orphans 2>/dev/null || true
        continue-on-error: true

      - name: Clean up old images
        run: |
          docker image prune -f || true
        continue-on-error: true

      - name: Build and start services
        working-directory: /opt/logarithm-warehouse
        run: |
          docker compose build
          docker compose up -d

      - name: Wait for services to be healthy
        working-directory: /opt/logarithm-warehouse
        run: |
          echo "‚è≥ Waiting for services to initialize..."
          sleep 60
          
          echo ""
          echo "=============================================="
          echo "üîç HEALTH CHECKS"
          echo "=============================================="
          
          # Check Nginx/Frontend
          echo ""
          echo "Checking Nginx Load Balancer..."
          for i in {1..15}; do
            if curl -sf http://localhost/health > /dev/null 2>&1; then
              echo "‚úÖ Nginx is healthy"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå Nginx health check failed after 15 attempts"
              docker compose logs nginx
              exit 1
            fi
            echo "   Attempt $i/15 - waiting 5s..."
            sleep 5
          done
          
          # Check Order Service
          echo ""
          echo "Checking Order Service..."
          for i in {1..15}; do
            if curl -sf http://localhost/order-health > /dev/null 2>&1; then
              echo "‚úÖ Order Service is healthy"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå Order Service health check failed after 15 attempts"
              docker compose logs order-service
              exit 1
            fi
            echo "   Attempt $i/15 - waiting 5s..."
            sleep 5
          done
          
          # Check Inventory Service
          echo ""
          echo "Checking Inventory Service..."
          for i in {1..15}; do
            if curl -sf http://localhost/inventory-health > /dev/null 2>&1; then
              echo "‚úÖ Inventory Service is healthy"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå Inventory Service health check failed after 15 attempts"
              docker compose logs inventory-service
              exit 1
            fi
            echo "   Attempt $i/15 - waiting 5s..."
            sleep 5
          done
          
          echo ""
          echo "‚úÖ All services are healthy!"

      - name: Run smoke tests
        working-directory: /opt/logarithm-warehouse
        run: |
          echo ""
          echo "=============================================="
          echo "üß™ SMOKE TESTS"
          echo "=============================================="
          
          echo ""
          echo "Test 1: Get Products..."
          PRODUCTS=$(curl -s http://localhost/inventory/products)
          if echo "$PRODUCTS" | grep -q '"success":true'; then
            echo "‚úÖ Products API working"
          else
            echo "‚ùå Products API failed"
            echo "$PRODUCTS"
            exit 1
          fi
          
          echo ""
          echo "Test 2: Get Orders..."
          ORDERS=$(curl -s http://localhost/orders)
          if echo "$ORDERS" | grep -q '"success":true'; then
            echo "‚úÖ Orders API working"
          else
            echo "‚ùå Orders API failed"
            echo "$ORDERS"
            exit 1
          fi
          
          echo ""
          echo "Test 3: Frontend accessible..."
          FRONTEND=$(curl -s http://localhost/)
          if echo "$FRONTEND" | grep -q 'Logarithm Warehouse'; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ùå Frontend not accessible"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All smoke tests passed!"

      - name: Deployment summary
        working-directory: /opt/logarithm-warehouse
        run: |
          echo ""
          echo "=============================================="
          echo "üìä DEPLOYMENT SUMMARY"
          echo "=============================================="
          
          echo ""
          echo "üê≥ Running Containers:"
          docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "=============================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "=============================================="
          echo ""
          echo "üåê Dashboard:   http://40.81.240.99"
          echo "üìä Grafana:     http://40.81.240.99:3000"
          echo "üìà Prometheus:  http://40.81.240.99:9090"
          echo ""
          echo "üîó API Endpoints:"
          echo "   - Orders:    http://40.81.240.99/orders"
          echo "   - Inventory: http://40.81.240.99/inventory/products"
          echo "   - Health:    http://40.81.240.99/health"
          echo ""

      - name: Show logs on failure
        if: failure()
        working-directory: /opt/logarithm-warehouse
        run: |
          echo "=============================================="
          echo "‚ùå DEPLOYMENT FAILED - Container Logs"
          echo "=============================================="
          docker compose logs --tail=150
